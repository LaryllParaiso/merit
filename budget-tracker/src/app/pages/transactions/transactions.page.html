<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>History</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" [scrollEvents]="true" (ionScrollStart)="closeSlidingItems()" (click)="closeSlidingItems()">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-list inset="true" class="filter-list">
    <ion-item lines="none">
      <ion-searchbar [(ngModel)]="searchText" (ionInput)="applyFilters()" placeholder="Search transactions..."></ion-searchbar>
    </ion-item>

    <ion-item lines="none">
      <ion-segment [(ngModel)]="typeFilter" (ionChange)="applyFilters()">
        <ion-segment-button value="all">
          <ion-label>All</ion-label>
        </ion-segment-button>
        <ion-segment-button value="income">
          <ion-label>Income</ion-label>
        </ion-segment-button>
        <ion-segment-button value="expense">
          <ion-label>Expense</ion-label>
        </ion-segment-button>
      </ion-segment>
    </ion-item>
  </ion-list>

  <ion-list #txList inset="true" class="tx-list">
    <ion-item *ngIf="!isLoading && filteredTransactions.length === 0">
      <ion-label>No transactions yet.</ion-label>
    </ion-item>

    <ion-item *ngIf="isLoading">
      <ion-skeleton-text animated style="width: 100%; height: 18px"></ion-skeleton-text>
    </ion-item>
    <ion-item *ngIf="isLoading">
      <ion-skeleton-text animated style="width: 100%; height: 18px"></ion-skeleton-text>
    </ion-item>
    <ion-item *ngIf="isLoading">
      <ion-skeleton-text animated style="width: 100%; height: 18px"></ion-skeleton-text>
    </ion-item>

    <ng-container *ngIf="!isLoading">
      <ng-container *ngFor="let t of filteredTransactions; let i = index; trackBy: trackById">
        <ion-item-divider *ngIf="i === 0 || t.date !== filteredTransactions[i - 1]?.date">
          <ion-label>{{ getSectionLabel(t.date) }}</ion-label>
        </ion-item-divider>

        <ion-item-sliding>
          <ion-item
            button
            detail="true"
            (click)="edit(t)"
            [attr.id]="'tx-' + t.id"
            [class.tx-focused]="t.id === focusedTxId"
          >
          <ion-icon
            slot="start"
            [name]="t.categoryIcon || 'pricetag'"
            [style.color]="t.categoryColor || 'var(--ion-color-medium)'"
          ></ion-icon>

          <ion-label>
            <h2>{{ t.categoryName || 'Unknown' }}</h2>
            <p>
              {{ t.date }}
              <span *ngIf="t.notes"> • {{ t.notes }}</span>
            </p>
          </ion-label>

          <ion-note slot="end" [color]="t.type === 'income' ? 'success' : 'danger'">
            {{ t.type === 'income' ? '+' : '-' }}₱{{ t.amount | number:'1.2-2' }}
          </ion-note>
          </ion-item>

          <ion-item-options side="end">
            <ion-item-option color="primary" (click)="edit(t)">Edit</ion-item-option>
            <ion-item-option color="danger" (click)="confirmDelete(t)">Delete</ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </ng-container>
    </ng-container>
  </ion-list>

  <ion-fab class="page-fab" slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button class="app-fab" (click)="addNew()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<ion-modal class="app-center-modal tx-modal" [isOpen]="isTxModalOpen" [backdropDismiss]="true" (didDismiss)="closeTxModal()">
  <ng-template>
    <ion-content class="tx-modal-content" [class.income-mode]="isIncome" [class.expense-mode]="!isIncome">
      <form [formGroup]="form">
        <div class="tx-modal-card">
          <div class="tx-type-row">
            <ion-segment formControlName="type" mode="ios" (ionChange)="onTxTypeChange($event)">
              <ion-segment-button value="expense">
                <ion-label>Expense</ion-label>
              </ion-segment-button>
              <ion-segment-button value="income">
                <ion-label>Income</ion-label>
              </ion-segment-button>
            </ion-segment>
          </div>

          <div class="tx-amount-hero" [style.color]="amountColor">
            ₱
            <ion-input
              class="tx-amount-input"
              type="number"
              inputmode="decimal"
              formControlName="amount"
              placeholder="0"
            ></ion-input>
          </div>

          <div class="tx-category-label">Category</div>
          <div class="tx-category-strip" *ngIf="txCategories.length > 0">
            <button
              type="button"
              class="tx-cat-tile"
              *ngFor="let c of txCategories; trackBy: trackByCategoryId"
              (click)="selectCategory(c)"
              [class.selected]="form.get('categoryId')?.value === c.id"
            >
              <div class="tx-cat-icon" [style.background]="c.color">
                <ion-icon [name]="c.icon"></ion-icon>
              </div>
              <div class="tx-cat-name">{{ c.name }}</div>
            </button>
          </div>

          <div class="tx-field">
            <ion-icon name="document-text-outline"></ion-icon>
            <ion-input formControlName="notes" placeholder="Description (optional)"></ion-input>
          </div>

          <div class="tx-field">
            <ion-icon name="calendar-outline"></ion-icon>
            <ion-input type="date" formControlName="date"></ion-input>
          </div>

          <div class="tx-actions">
            <ion-button class="tx-cancel" type="button" fill="solid" (click)="closeTxModal()">
              Cancel
            </ion-button>
            <ion-button
              class="tx-save"
              type="button"
              fill="solid"
              (click)="saveTx()"
              [disabled]="isTxSaving || form.invalid"
            >
              <ion-spinner *ngIf="isTxSaving" name="dots" slot="start"></ion-spinner>
              Save
            </ion-button>
          </div>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
